---
import Base from "@/layouts/Base.astro";
---

<Base title="å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æµ‹è¯•">
  <div class="container py-20">
    <h1 class="text-3xl font-bold mb-6">å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æµ‹è¯•</h1>

    <div id="editor-wrapper">
      <div id="toolbar-container"><!-- å·¥å…·æ  --></div>
      <div id="editor-container"><!-- ç¼–è¾‘å™¨ --></div>
    </div>

    <div class="mt-6">
      <button
        id="btn-get-html"
        class="px-4 py-2 bg-blue-500 text-white rounded"
      >
        è·å– HTML
      </button>
      <button
        id="btn-get-text"
        class="px-4 py-2 bg-green-500 text-white rounded ml-2"
      >
        è·å–çº¯æ–‡æœ¬
      </button>
    </div>

    <div id="output" class="mt-4 p-4 bg-gray-100 rounded hidden">
      <h3 class="font-bold mb-2">è¾“å‡ºå†…å®¹ï¼š</h3>
      <pre class="whitespace-pre-wrap"></pre>
    </div>
  </div>
</Base>

<style>
  #editor-wrapper {
    border: 1px solid #ccc;
    z-index: 100;
  }
  #toolbar-container {
    border-bottom: 1px solid #ccc;
  }
  #editor-container {
    height: 500px;
    overflow-y: auto;
  }
</style>

<script>
  // ä½¿ç”¨ type="module" è®©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ import
  import { createEditor, createToolbar } from "@wangeditor/editor";
  import type { IDomEditor } from "@wangeditor/editor";

  // å®šä¹‰å›¾ç‰‡å…ƒç´ ç±»å‹
  type ImageElement = {
    src: string;
    alt: string;
    url: string;
    href: string;
  };

  // å®šä¹‰è§†é¢‘å…ƒç´ ç±»å‹
  type VideoElement = {
    src: string;
    poster?: string;
  };

  // ç­‰å¾… DOM åŠ è½½å®Œæˆ
  window.addEventListener("DOMContentLoaded", () => {
    const editorConfig: any = {
      placeholder: "è¯·è¾“å…¥å†…å®¹...æ”¯æŒå›¾ç‰‡å’Œè§†é¢‘ä¸Šä¼ ",
      onChange(editor: IDomEditor) {
        const html = editor.getHtml();
        console.log("ç¼–è¾‘å™¨å†…å®¹:", html);
      },
      // é…ç½®ä¸Šä¼ å›¾ç‰‡å’Œè§†é¢‘
      MENU_CONF: {},
    };

    // é…ç½®å›¾ç‰‡ä¸Šä¼ 
    editorConfig.MENU_CONF["uploadImage"] = {
      server: "/api/upload-image",
      fieldName: "wangeditor-uploaded-image",

      // å•ä¸ªæ–‡ä»¶çš„æœ€å¤§ä½“ç§¯é™åˆ¶ï¼Œæ”¹ä¸º 5M
      maxFileSize: 5 * 1024 * 1024, // 5M

      // æœ€å¤šå¯ä¸Šä¼ å‡ ä¸ªæ–‡ä»¶
      maxNumberOfFiles: 10,

      // é€‰æ‹©æ–‡ä»¶æ—¶çš„ç±»å‹é™åˆ¶
      allowedFileTypes: ["image/*"],

      // è·¨åŸŸæ˜¯å¦ä¼ é€’ cookie
      withCredentials: false,

      // è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 10 ç§’
      timeout: 10 * 1000,

      // ä¸Šä¼ ä¹‹å‰è§¦å‘
      onBeforeUpload(file: File) {
        console.log("å‡†å¤‡ä¸Šä¼ :", file.name);
        return file;
      },

      // ä¸Šä¼ è¿›åº¦çš„å›è°ƒå‡½æ•°
      onProgress(progress: number) {
        console.log("ä¸Šä¼ è¿›åº¦:", progress);
      },

      // å•ä¸ªæ–‡ä»¶ä¸Šä¼ æˆåŠŸä¹‹å
      onSuccess(file: File, res: any) {
        console.log(`${file.name} ä¸Šä¼ æˆåŠŸ`, res);
      },

      // å•ä¸ªæ–‡ä»¶ä¸Šä¼ å¤±è´¥
      onFailed(file: File, res: any) {
        console.error(`${file.name} ä¸Šä¼ å¤±è´¥`, res);
        alert(`${file.name} ä¸Šä¼ å¤±è´¥: ${res.message || "æœªçŸ¥é”™è¯¯"}`);
      },

      // ä¸Šä¼ é”™è¯¯ï¼Œæˆ–è€…è§¦å‘ timeout è¶…æ—¶
      onError(file: File, err: any, res: any) {
        console.error(`${file.name} ä¸Šä¼ å‡ºé”™`, err, res);
        alert(`${file.name} ä¸Šä¼ å‡ºé”™`);
      },
    };

    // é…ç½®æ’å…¥å›¾ç‰‡
    editorConfig.MENU_CONF["insertImage"] = {
      onInsertedImage(imageNode: ImageElement | null) {
        if (imageNode == null) return;
        const { src, alt, url, href } = imageNode;
        console.log("æ’å…¥å›¾ç‰‡", src, alt, url, href);
      },
    };

    // é…ç½®è§†é¢‘ä¸Šä¼ 
    editorConfig.MENU_CONF["uploadVideo"] = {
      server: "/api/upload-video",
      fieldName: "wangeditor-uploaded-video",

      // å•ä¸ªæ–‡ä»¶çš„æœ€å¤§ä½“ç§¯é™åˆ¶ï¼Œé»˜è®¤ä¸º 10Mï¼Œè¿™é‡Œè®¾ç½®ä¸º 50M
      maxFileSize: 50 * 1024 * 1024, // 50M

      // æœ€å¤šå¯ä¸Šä¼ å‡ ä¸ªæ–‡ä»¶ï¼Œé»˜è®¤ä¸º 5
      maxNumberOfFiles: 3,

      // é€‰æ‹©æ–‡ä»¶æ—¶çš„ç±»å‹é™åˆ¶
      allowedFileTypes: ["video/*"],

      // è·¨åŸŸæ˜¯å¦ä¼ é€’ cookie
      withCredentials: false,

      // è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 30 ç§’ï¼Œè§†é¢‘è¾ƒå¤§å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
      timeout: 60 * 1000, // 60 ç§’

      // ä¸Šä¼ ä¹‹å‰è§¦å‘
      onBeforeUpload(file: File) {
        console.log("å‡†å¤‡ä¸Šä¼ è§†é¢‘:", file.name);
        return file;
      },

      // ä¸Šä¼ è¿›åº¦çš„å›è°ƒå‡½æ•°
      onProgress(progress: number) {
        console.log("è§†é¢‘ä¸Šä¼ è¿›åº¦:", progress);
      },

      // å•ä¸ªæ–‡ä»¶ä¸Šä¼ æˆåŠŸä¹‹å
      onSuccess(file: File, res: any) {
        console.log(`${file.name} ä¸Šä¼ æˆåŠŸ`, res);
      },

      // å•ä¸ªæ–‡ä»¶ä¸Šä¼ å¤±è´¥
      onFailed(file: File, res: any) {
        console.error(`${file.name} ä¸Šä¼ å¤±è´¥`, res);
        alert(`${file.name} ä¸Šä¼ å¤±è´¥: ${res.message || "æœªçŸ¥é”™è¯¯"}`);
      },

      // ä¸Šä¼ é”™è¯¯ï¼Œæˆ–è€…è§¦å‘ timeout è¶…æ—¶
      onError(file: File, err: any, res: any) {
        console.error(`${file.name} ä¸Šä¼ å‡ºé”™`, err, res);
        alert(`${file.name} ä¸Šä¼ å‡ºé”™ï¼Œå¯èƒ½æ–‡ä»¶è¿‡å¤§æˆ–ç½‘ç»œè¶…æ—¶`);
      },
    };

    // é…ç½®æ’å…¥è§†é¢‘
    editorConfig.MENU_CONF["insertVideo"] = {
      onInsertedVideo(videoNode: VideoElement | null) {
        if (videoNode == null) return;
        const { src, poster } = videoNode;
        console.log("æ’å…¥è§†é¢‘", src, poster);
      },
      // è‡ªå®šä¹‰æ ¡éªŒè§†é¢‘
      checkVideo(src: string, poster: string): boolean | string | undefined {
        if (!src) {
          return;
        }
        if (src.indexOf("http") !== 0 && src.indexOf("/") !== 0) {
          return "è§†é¢‘åœ°å€å¿…é¡»ä»¥ http/https å¼€å¤´æˆ–ä¸ºç›¸å¯¹è·¯å¾„";
        }
        return true;
      },
    };

    const editor = createEditor({
      selector: "#editor-container",
      html: "<p>Hello World! è¿™æ˜¯ä¸€ä¸ªå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ã€‚</p><p>âœ¨ æ”¯æŒä¸Šä¼ <strong>å›¾ç‰‡</strong>å’Œ<strong>è§†é¢‘</strong></p><p>ğŸ“¸ å›¾ç‰‡æœ€å¤§ 5MB</p><p>ğŸ¬ è§†é¢‘æœ€å¤§ 50MB</p>",
      config: editorConfig,
      mode: "default",
    });

    const toolbarConfig = {};

    const toolbar = createToolbar({
      editor,
      selector: "#toolbar-container",
      config: toolbarConfig,
      mode: "default",
    });

    // è·å– HTML æŒ‰é’®
    document.getElementById("btn-get-html")?.addEventListener("click", () => {
      const html = editor.getHtml();
      const output = document.getElementById("output");
      const pre = output?.querySelector("pre");
      if (output && pre) {
        output.classList.remove("hidden");
        pre.textContent = html;
      }
    });

    // è·å–çº¯æ–‡æœ¬æŒ‰é’®
    document.getElementById("btn-get-text")?.addEventListener("click", () => {
      const text = editor.getText();
      const output = document.getElementById("output");
      const pre = output?.querySelector("pre");
      if (output && pre) {
        output.classList.remove("hidden");
        pre.textContent = text;
      }
    });

    // é¡µé¢å¸è½½æ—¶é”€æ¯ç¼–è¾‘å™¨
    window.addEventListener("beforeunload", () => {
      editor.destroy();
    });
  });
</script>

<!-- å¼•å…¥ç¼–è¾‘å™¨æ ·å¼ -->
<link
  href="https://unpkg.com/@wangeditor/editor@latest/dist/css/style.css"
  rel="stylesheet"
/>
